on:
  pull_request:
jobs:
  configure:
    runs-on: ubuntu-latest
    outputs:
      run_rollup_all: ${{steps.run_rollup_all.outputs.run_rollup_all}}
    steps:
      - id: run_rollup_all
        run: echo "run_rollup_all=true" >> "$GITHUB_OUTPUT"

  a-shard:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        number: [1, 2]
    steps:
      - run: |
          echo ${{ matrix.number }}
          if [[ "${{ matrix.number }}" == "2" ]]; then
            echo "failing shard ${{ matrix.number}}"
            exit 1
          else
              echo "passing shard ${{ matrix.number }}"
          fi

  roll-up-a:
    needs: [a-shard]
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    steps:
      - run: echo a-shard-result=${{ needs.a-shard.result }}
      - if: success()
        run: echo "success"
      - if: cancelled()
        run: echo "cancelled"
      - if: always()
        run: echo "always"
      - if: failure()
        run: |
          echo "failure"
          exit 1

  b-shard:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        number: [1, 2]
    steps:
      - run: echo ${{ matrix.number }}

  roll-up-b:
    needs: [b-shard]
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    steps:
      - run: echo b-shard-result=${{ needs.b-shard.result }}
      - if: success()
        run: echo "success"
      - if: cancelled()
        run: echo "cancelled"
      - if: always()
        run: echo "always"
      - if: failure()
        run: |
          echo "failure"
          exit 1

  roll-up-all:
    runs-on: ubuntu-latest
    needs: [roll-up-a, roll-up-b, configure]
    if: ${{ !cancelled() && needs.configure.outputs.run_rollup_all == 'true' }}
    steps:
      - run: echo rollup-a-result=${{ needs.roll-up-a.result }}
      - run: echo rollup-b-result=${{ needs.roll-up-b.result }}
      - if: failure()
        run: echo "failure"
      - if: success()
        run: echo "success"
      - if: cancelled()
        run: echo "cancelled"
      - if: always()
        run: echo "always"
